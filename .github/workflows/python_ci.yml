name: Python Tests

on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff linter
        run: ruff check python/src/smooth/

      - name: Run ruff formatter check
        run: ruff format --check python/src/smooth/

  test:
    name: Test (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        include:
          - os: macos-latest
            python-version: "3.11"
          - os: windows-latest
            python-version: "3.11"

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libarmadillo-dev libblas-dev liblapack-dev cmake ninja-build

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install armadillo cmake ninja

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake ninja
          
      - name: Install OpenBLAS and LAPACK via vcpkg (Windows)
        if: runner.os == 'Windows'
        run: |
          vcpkg install openblas:x64-windows-release lapack:x64-windows-release
        shell: pwsh

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov numpy

      - name: Build and install package (Unix)
        if: runner.os != 'Windows'
        working-directory: python
        run: |
          pip install -e ".[dev]"

      - name: Build and install package (Windows)
        if: runner.os == 'Windows'
        working-directory: python
        run: |
          pip install -e ".[dev]"
        env:
          CMAKE_ARGS: -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-release

      - name: Run tests with pytest (Unix)
        if: runner.os != 'Windows'
        working-directory: python
        run: |
          pytest tests/ -v --tb=short -ra

      - name: Run tests with pytest (Windows)
        if: runner.os == 'Windows'
        working-directory: python
        run: |
          $env:PATH = "C:\vcpkg\installed\x64-windows-release\bin;$env:PATH"
          pytest tests/ -v --tb=short -ra
        shell: pwsh

      - name: Run tests with coverage
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        working-directory: python
        run: |
          pip install coverage
          coverage run -m pytest tests/ -v
          coverage xml -o coverage.xml
          coverage report

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: python/coverage.xml
          fail_ci_if_error: false
          verbose: true

  test-import:
    name: Test Import
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libarmadillo-dev libblas-dev liblapack-dev cmake ninja-build

      - name: Build and install package
        working-directory: python
        run: |
          pip install .

      - name: Test imports
        run: |
          python -c "from smooth import ADAM, ES, msdecompose, lowess"
          python -c "from smooth.adam_general import lowess_cpp"
          echo "All imports successful!"
